package com.yishuifengxiao.common.tool.text;

import com.yishuifengxiao.common.tool.lang.TLV;
import org.junit.Test;

import static org.junit.Assert.*;
import static org.junit.Assert.assertEquals;

/**
 * @author yishui
 * @version 1.0.0
 * @since 1.0.0
 */
public class TLV_parse_Test {

    @Test
    public void test_parse() {
        String data = "A08205963081DF80082D458E40BEB4AC5C8324687474703A2F2F3139322E3136382E3132342E31383A383630302F706572736F6E6B69748400BF226D810302030182030202008303040200840D8101008204000529508302401D850506FD321BC08603090200870302030088020490A9160414C7D3E3846D27A5C0C1371E99D36438E70DEC7AFDAA160414C7D3E3846D27A5C0C1371E99D36438E70DEC7AFD8B010099000403000101A03B801743383838312D33444433342D31463431362D3542313233A11C800468535950A10585030900008208685359506415000F850307E580820207805F3740F9EF3D52962841BF9244CB23CDE40FC7DA0B454E07B3BB536DBB43492772C98F87B430674D94D314908AE6EE6B5A0B619A32DB1C74A218B5C3C32DE4DB11437B308201F43082019BA003020102020106300A06082A8648CE3D0403023037310B300906035504061302444531153013060355040A0C0C52535020546573742045554D3111300F06035504030C0845554D2054657374301E170D3235303632343039303232385A170D3236303632343039303232385A3064310B300906035504061302444531153013060355040A0C0C52535020546573742045554D312930270603550405132038393030313132323333343435353636373738383939414142424343444445453113301106035504030C0A546573742065554943433059301306072A8648CE3D020106082A8648CE3D030107034200048F8CDD26616C94A57DCC6A1375347D39A1F19DBB5A029A4CECAA73D583CBBDD1E659659EBE84E2F122ACA66BB696F20797C366C0C00E58AA38D6D5AA215F7C4EA36B3069301D0603551D0E04160414F3DECF66C4FFA3A9937B2E85747FFC0E1B5FFF4F301F0603551D2304183016801486DAAE103B4A0282E52B1D50E5551934BFF83721300E0603551D0F0101FF04040302078030170603551D200101FF040D300B3009060767811201020101300A06082A8648CE3D0403020347003044022047B305E36E2B41D590FEC0D62724C125B8878832D68525A402F82A3DE93BEFA102201A78D6B385C0FDBA53AA3224D07A1B7C6F79C69F390D78670E1549BD17F2E391308202753082021CA003020102020102300A06082A8648CE3D04030230493115301306035504030C0C47534D4120546573742043493111300F060355040B0C0854455354434552543110300E060355040A0C0752535054455354310B3009060355040613024954301E170D3235303632343039303232375A170D3236303632343039303232375A3037310B300906035504061302444531153013060355040A0C0C52535020546573742045554D3111300F06035504030C0845554D20546573743059301306072A8648CE3D020106082A8648CE3D03010703420004EEA9AEFD4E6915D5FFB0A12D591F63A7A204C36C8014DA07E5F6143DC77626901D27A86F8AF9CE77DB5883AED9835D768EEE35C03D887F0F59D0E15B0A5132D3A382010530820101301D0603551D0E0416041486DAAE103B4A0282E52B1D50E5551934BFF83721301F0603551D23041830168014C7D3E3846D27A5C0C1371E99D36438E70DEC7AFD300E0603551D0F0101FF04040302020430170603551D200101FF040D300B3009060767811201020102300E0603551D1104073005880388370530120603551D130101FF040830060101FF02010030320603551D1F042B30293027A025A0238621687474703A2F2F63692E746573742E67736D612E636F6D2F43524C2D422E63726C303E0603551D1E0101FF04343032A030302EA42C302A31153013060355040A0C0C52535020546573742045554D3111300F060355040513083839303439303332300A06082A8648CE3D04030203470030440220283C05943FA5B8286516771275B9A78FE43DE33F282B396C60D7097CB30B157002203E1D81914644E5853707E78F5F552D04D68A59954EC22FC9F66EB007F6F88B5C";
        TLV authenticateResponseOkTLV = TLV.of(data).parse("A0");
        assertEquals(authenticateResponseOkTLV.getValue(), "3081DF80082D458E40BEB4AC5C8324687474703A2F2F3139322E3136382E3132342E31383A383630302F706572736F6E6B69748400BF226D810302030182030202008303040200840D8101008204000529508302401D850506FD321BC08603090200870302030088020490A9160414C7D3E3846D27A5C0C1371E99D36438E70DEC7AFDAA160414C7D3E3846D27A5C0C1371E99D36438E70DEC7AFD8B010099000403000101A03B801743383838312D33444433342D31463431362D3542313233A11C800468535950A10585030900008208685359506415000F850307E580820207805F3740F9EF3D52962841BF9244CB23CDE40FC7DA0B454E07B3BB536DBB43492772C98F87B430674D94D314908AE6EE6B5A0B619A32DB1C74A218B5C3C32DE4DB11437B308201F43082019BA003020102020106300A06082A8648CE3D0403023037310B300906035504061302444531153013060355040A0C0C52535020546573742045554D3111300F06035504030C0845554D2054657374301E170D3235303632343039303232385A170D3236303632343039303232385A3064310B300906035504061302444531153013060355040A0C0C52535020546573742045554D312930270603550405132038393030313132323333343435353636373738383939414142424343444445453113301106035504030C0A546573742065554943433059301306072A8648CE3D020106082A8648CE3D030107034200048F8CDD26616C94A57DCC6A1375347D39A1F19DBB5A029A4CECAA73D583CBBDD1E659659EBE84E2F122ACA66BB696F20797C366C0C00E58AA38D6D5AA215F7C4EA36B3069301D0603551D0E04160414F3DECF66C4FFA3A9937B2E85747FFC0E1B5FFF4F301F0603551D2304183016801486DAAE103B4A0282E52B1D50E5551934BFF83721300E0603551D0F0101FF04040302078030170603551D200101FF040D300B3009060767811201020101300A06082A8648CE3D0403020347003044022047B305E36E2B41D590FEC0D62724C125B8878832D68525A402F82A3DE93BEFA102201A78D6B385C0FDBA53AA3224D07A1B7C6F79C69F390D78670E1549BD17F2E391308202753082021CA003020102020102300A06082A8648CE3D04030230493115301306035504030C0C47534D4120546573742043493111300F060355040B0C0854455354434552543110300E060355040A0C0752535054455354310B3009060355040613024954301E170D3235303632343039303232375A170D3236303632343039303232375A3037310B300906035504061302444531153013060355040A0C0C52535020546573742045554D3111300F06035504030C0845554D20546573743059301306072A8648CE3D020106082A8648CE3D03010703420004EEA9AEFD4E6915D5FFB0A12D591F63A7A204C36C8014DA07E5F6143DC77626901D27A86F8AF9CE77DB5883AED9835D768EEE35C03D887F0F59D0E15B0A5132D3A382010530820101301D0603551D0E0416041486DAAE103B4A0282E52B1D50E5551934BFF83721301F0603551D23041830168014C7D3E3846D27A5C0C1371E99D36438E70DEC7AFD300E0603551D0F0101FF04040302020430170603551D200101FF040D300B3009060767811201020102300E0603551D1104073005880388370530120603551D130101FF040830060101FF02010030320603551D1F042B30293027A025A0238621687474703A2F2F63692E746573742E67736D612E636F6D2F43524C2D422E63726C303E0603551D1E0101FF04343032A030302EA42C302A31153013060355040A0C0C52535020546573742045554D3111300F060355040513083839303439303332300A06082A8648CE3D04030203470030440220283C05943FA5B8286516771275B9A78FE43DE33F282B396C60D7097CB30B157002203E1D81914644E5853707E78F5F552D04D68A59954EC22FC9F66EB007F6F88B5C");

        TLV euiccSigned1TLV = TLV.of(authenticateResponseOkTLV.getValue()).parse("30");
        assertEquals(euiccSigned1TLV.getValue(), "80082D458E40BEB4AC5C8324687474703A2F2F3139322E3136382E3132342E31383A383630302F706572736F6E6B69748400BF226D810302030182030202008303040200840D8101008204000529508302401D850506FD321BC08603090200870302030088020490A9160414C7D3E3846D27A5C0C1371E99D36438E70DEC7AFDAA160414C7D3E3846D27A5C0C1371E99D36438E70DEC7AFD8B010099000403000101A03B801743383838312D33444433342D31463431362D3542313233A11C800468535950A10585030900008208685359506415000F850307E58082020780");
        TLV euiccSignature1TLV = euiccSigned1TLV.parseRemaining("5F37");
        assertEquals(euiccSignature1TLV.getValue(), "F9EF3D52962841BF9244CB23CDE40FC7DA0B454E07B3BB536DBB43492772C98F87B430674D94D314908AE6EE6B5A0B619A32DB1C74A218B5C3C32DE4DB11437B");
        TLV euiccCertificateTLV = euiccSignature1TLV.parseRemaining("30");
        assertEquals(euiccCertificateTLV.getValue(), "3082019BA003020102020106300A06082A8648CE3D0403023037310B300906035504061302444531153013060355040A0C0C52535020546573742045554D3111300F06035504030C0845554D2054657374301E170D3235303632343039303232385A170D3236303632343039303232385A3064310B300906035504061302444531153013060355040A0C0C52535020546573742045554D312930270603550405132038393030313132323333343435353636373738383939414142424343444445453113301106035504030C0A546573742065554943433059301306072A8648CE3D020106082A8648CE3D030107034200048F8CDD26616C94A57DCC6A1375347D39A1F19DBB5A029A4CECAA73D583CBBDD1E659659EBE84E2F122ACA66BB696F20797C366C0C00E58AA38D6D5AA215F7C4EA36B3069301D0603551D0E04160414F3DECF66C4FFA3A9937B2E85747FFC0E1B5FFF4F301F0603551D2304183016801486DAAE103B4A0282E52B1D50E5551934BFF83721300E0603551D0F0101FF04040302078030170603551D200101FF040D300B3009060767811201020101300A06082A8648CE3D0403020347003044022047B305E36E2B41D590FEC0D62724C125B8878832D68525A402F82A3DE93BEFA102201A78D6B385C0FDBA53AA3224D07A1B7C6F79C69F390D78670E1549BD17F2E391");
        TLV eumCertificateTLV = euiccCertificateTLV.parseRemaining("30");
        assertEquals(eumCertificateTLV.getValue(), "3082021CA003020102020102300A06082A8648CE3D04030230493115301306035504030C0C47534D4120546573742043493111300F060355040B0C0854455354434552543110300E060355040A0C0752535054455354310B3009060355040613024954301E170D3235303632343039303232375A170D3236303632343039303232375A3037310B300906035504061302444531153013060355040A0C0C52535020546573742045554D3111300F06035504030C0845554D20546573743059301306072A8648CE3D020106082A8648CE3D03010703420004EEA9AEFD4E6915D5FFB0A12D591F63A7A204C36C8014DA07E5F6143DC77626901D27A86F8AF9CE77DB5883AED9835D768EEE35C03D887F0F59D0E15B0A5132D3A382010530820101301D0603551D0E0416041486DAAE103B4A0282E52B1D50E5551934BFF83721301F0603551D23041830168014C7D3E3846D27A5C0C1371E99D36438E70DEC7AFD300E0603551D0F0101FF04040302020430170603551D200101FF040D300B3009060767811201020102300E0603551D1104073005880388370530120603551D130101FF040830060101FF02010030320603551D1F042B30293027A025A0238621687474703A2F2F63692E746573742E67736D612E636F6D2F43524C2D422E63726C303E0603551D1E0101FF04343032A030302EA42C302A31153013060355040A0C0C52535020546573742045554D3111300F060355040513083839303439303332300A06082A8648CE3D04030203470030440220283C05943FA5B8286516771275B9A78FE43DE33F282B396C60D7097CB30B157002203E1D81914644E5853707E78F5F552D04D68A59954EC22FC9F66EB007F6F88B5C");
    }

    @Test
    public void test_nested() {
        String data = "9F07053003A00101";
        TLV tlv1 = TLV.of(data).parse("9F07");
        assertEquals("3003A00101", tlv1.getValue());
        TLV tlv2 = tlv1.parse("30");  // 使用parseValue进行链式解析
        assertEquals("A00101", tlv2.getValue());
        TLV tlv3 = tlv2.parse("A0");  // 使用parseValue进行链式解析
        assertEquals("01", tlv3.getValue());
    }

    @Test
    public void test_not_found() {
        String data = "9F07053003A00101";
        TLV tlv1 = TLV.of(data).parse("9F06");
        assertEquals(data, tlv1.getRemainingData());
        assertEquals("", tlv1.getValue());
        assertTrue(tlv1.getError().contains("数据不以指定标签开头"));
        assertFalse(tlv1.isSuccess());
        TLV tlv2 = tlv1.parseRemaining("9F09");
        assertEquals(data, tlv2.getRemainingData());
        assertEquals("", tlv2.getValue());
        assertEquals("没有剩余数据可用于解析", tlv2.getError());
        assertFalse(tlv2.isSuccess());
        TLV tlv3 = tlv2.parse("9F07");
        assertEquals("", tlv3.getRemainingData());
        assertEquals("3003A00101", tlv3.getValue());
        assertTrue(tlv3.isSuccess());
        assertTrue(tlv3.getError().trim().isEmpty());
    }

    static String text = """
            30 81DF
                80 08 57DE2525FC07CD79
                83 24 687474703A2F2F3139322E3136382E3132342E31383A383630302F706572736F6E6B6974
                84 00
                BF22 6D
                    81 03 020301
                    82 03 020200
                    83 03 040200
                    84 0D
                        81 01 00
                        82 04 00052950
                        83 02 401D
                    85 05 06FD321BC0
                    86 03 090200
                    87 03 020300
                    88 02 0490
                    A9 16
                        04 14 C7D3E3846D27A5C0C1371E99D36438E70DEC7AFD
                    AA 16
                        04 14 C7D3E3846D27A5C0C1371E99D36438E70DEC7AFD
                    8B 01 00
                    99 00
                    04 03
                        00 01 01
                A0 3B
                    80 17 43383838312D33444433342D31463431362D3542313233
                    A1 1C
                        80 04 68535950
                        A1 05
                            85 03 090000
                        82 08 685359506415000F
                        85 03 07E580
                    82 02 0780
            """.replaceAll("\\s", "").trim();
}